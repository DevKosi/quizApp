<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Quiz Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .table-row:hover {
      background-color: #f8fafc;
    }

    .btn-hover:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-hover {
      transition: all 0.2s ease;
    }

    .highlight {
      animation: highlight 2s;
    }

    @keyframes highlight {
      0% {
        background-color: rgba(16, 185, 129, 0.3);
      }

      100% {
        background-color: transparent;
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="w-full max-w-6xl mx-auto bg-white shadow-md rounded-xl p-6 mt-10 mb-10">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-chart-bar mr-2 text-blue-500"></i> Quiz Results
      </h1>
      <div class="flex items-center space-x-2">
        <button onclick="location.href='admin-dashboard.html'"
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg flex items-center btn-hover">
          <i class="fas fa-arrow-left mr-2"></i> Back
        </button>
        <button id="downloadClearBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center btn-hover">
          <i class="fas fa-download mr-2"></i> Download & Clear
        </button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="min-w-full text-sm text-left text-gray-700">
        <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-600">
          <tr>
            <th class="px-4 py-3">Reg Number</th>
            <th class="px-4 py-3">Department</th>
            <th class="px-4 py-3">Score</th>
            <th class="px-4 py-3">Total</th>
            <th class="px-4 py-3">Percentage</th>
            <th class="px-4 py-3">Timestamp</th>
          </tr>
        </thead>
        <tbody id="resultsTable" class="divide-y divide-gray-100">
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-500">
              <i class="fas fa-spinner fa-spin mr-2"></i> Loading results...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCB3oLoV2YyX0Io16Ep2rxxbs38W1tIxRo",
      authDomain: "trailquizz.firebaseapp.com",
      projectId: "trailquizz",
      storageBucket: "trailquizz.firebasestorage.app",
      messagingSenderId: "1016471794742",
      appId: "1:1016471794742:web:4214c5184b90113a7d9497"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const school = "EBSU";
    const year = "2023";
    let lastVisible = null;
    let isLoading = false;
    let isEndReached = false;
    const pageSize = 10;

    async function loadResults(initial = false) {
      if (isLoading || isEndReached) return;

      isLoading = true;
      const tableBody = document.getElementById('resultsTable');
      if (initial) tableBody.innerHTML = '';

      try {
        let query = db.collection("Results").doc(school).collection(year)
          .orderBy("timestamp", "desc")
          .limit(pageSize);

        if (lastVisible) {
          query = query.startAfter(lastVisible);
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
          if (initial) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No results found.</td></tr>';
          }
          isEndReached = true;
          return;
        }

        lastVisible = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach((doc, index) => {
          const data = doc.data();
          const timestamp = data.timestamp?.toDate?.() || new Date(data.timestamp || Date.now());
          const percentage = Math.round((data.score / data.total) * 100);

          const row = document.createElement('tr');
          row.className = 'table-row';
          row.innerHTML = `
            <td class="px-4 py-2 font-medium">${data.regNumber || 'N/A'}</td>
            <td class="px-4 py-2">${data.department || 'N/A'}</td>
            <td class="px-4 py-2 font-medium">${data.score}</td>
            <td class="px-4 py-2">${data.total}</td>
            <td class="px-4 py-2 font-medium ${getPercentageColor(percentage)}">${percentage}%</td>
            <td class="px-4 py-2">${timestamp.toLocaleString()}</td>
          `;
          tableBody.appendChild(row);
        });

      } catch (err) {
        console.error("Error loading results:", err);
      } finally {
        isLoading = false;
      }
    }

    function getPercentageColor(percentage) {
      if (percentage >= 70) return 'text-green-600';
      if (percentage >= 50) return 'text-yellow-600';
      return 'text-red-600';
    }

    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (
          window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 &&
          !isLoading && !isEndReached
        ) {
          loadResults(false);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadResults(true);         // load first batch
      setupInfiniteScroll();     // enable infinite scroll

      document.getElementById('downloadClearBtn').addEventListener('click', async () => {
        try {
          const snapshot = await db.collection("Results").doc(school).collection(year).get();

          if (snapshot.empty) return alert("No results to download.");

          const rows = [["Reg Number", "Department", "Score", "Total", "Percentage", "Timestamp"]];
          snapshot.forEach(doc => {
            const d = doc.data();
            const perc = Math.round((d.score / d.total) * 100);
            const time = d.timestamp?.toDate?.() || new Date(d.timestamp || Date.now());
            rows.push([d.regNumber, d.department, d.score, d.total, `${perc}%`, time.toLocaleString()]);
          });

          const csv = rows.map(r => r.join(",")).join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `quiz-results-${school}-${year}.csv`;
          a.click();
          URL.revokeObjectURL(url);

          if (confirm("Download complete. Clear all results?")) {
            const batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            lastVisible = null;
            isEndReached = false;
            loadResults(true);
          }
        } catch (err) {
          console.error("Error:", err);
          alert("An error occurred. See console for details.");
        }
      });
    });
  </script>
